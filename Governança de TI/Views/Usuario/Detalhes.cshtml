@model Governança_de_TI.Models.UsuarioModel
@inject Governança_de_TI.Data.ApplicationDbContext _context

@{
    ViewData["Title"] = "Detalhes do Responsável";

    // Busca as 5 atividades mais recentes do usuário
    var atividadesRecentes = _context.AuditLogs
        .Where(log => log.UsuarioId == Model.Id)
        .OrderByDescending(log => log.Timestamp)
        .Take(5)
        .ToList();
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0 text-muted">Controle de Responsáveis</h4>
                    <h5 class="mb-0">Detalhes</h5>
                </div>

                <!-- ===================== PERFIL DO USUÁRIO ===================== -->
                <div class="d-flex align-items-center mb-4">
                    @if (Model.FotoPerfil != null && Model.FotoPerfil.Length > 0)
                    {
                        var base64 = Convert.ToBase64String(Model.FotoPerfil);
                        var imgSrc = $"data:image/png;base64,{base64}";
                        <img src="@imgSrc" class="rounded-circle shadow-sm me-3"
                             style="width:120px;height:120px;object-fit:cover;border:1px solid #ccc;" />
                    }
                    else
                    {
                        <img src="~/img/default-user.png" class="rounded-circle shadow-sm me-3"
                             style="width:120px;height:120px;object-fit:cover;border:1px solid #ccc;" />
                    }

                    <div>
                        <h4 class="mb-0">@Model.Nome</h4>
                        <p class="text-muted mb-0">@Model.Email</p>
                    </div>
                </div>

                <hr />

                <!-- ===================== INFORMAÇÕES GERAIS ===================== -->
                <h6>Informações Gerais</h6>
                <dl class="row mt-3">
                    <dt class="col-sm-4">Perfil de Acesso</dt>
                    <dd class="col-sm-8">@Model.Perfil</dd>

                    <dt class="col-sm-4">Departamento</dt>
                    <dd class="col-sm-8">@Model.Departamento ?? "Não informado"</dd>

                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        @if (Model.Status == "Ativo")
                        {
                            <span class="badge bg-success">@Model.Status</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@Model.Status</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Data de Cadastro</dt>
                    <dd class="col-sm-8">@Model.DataDeCadastro.ToString("g")</dd>
                </dl>

                <hr />

                <!-- ===================== SEGURANÇA E ACESSO ===================== -->
                <h6>Segurança e Acesso</h6>
                <dl class="row mt-3">
                    <dt class="col-sm-4">Último Login</dt>
                    <dd class="col-sm-8">@(Model.DataUltimoLogin?.ToString("g") ?? "Nunca")</dd>
                </dl>

                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-warning"
                            data-bs-toggle="modal" data-bs-target="#modalRedefinirSenha">
                        <i class="bi bi-key me-2"></i>Redefinir Senha e Enviar por E-mail
                    </button>
                </div>

                <hr />

                <!-- ===================== ATIVIDADE RECENTE ===================== -->
                <h6>Atividade Recente</h6>

                @if (atividadesRecentes.Any())
                {
                    <ul class="list-group list-group-flush small mt-3"
                        style="max-height:250px;overflow-y:auto;overflow-x:hidden;border:1px solid #eee;border-radius:6px;">
                        @foreach (var atividade in atividadesRecentes)
                        {
                            <li class="list-group-item px-0">
                                <strong>@atividade.Acao:</strong> @atividade.Detalhes
                                <span class="text-muted d-block" style="font-size:0.8rem;">
                                    em @atividade.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")
                                </span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted mt-3">Nenhuma atividade recente registrada para este utilizador.</p>
                }

                <!-- ===================== BOTÕES DE AÇÃO ===================== -->
                <div class="d-flex justify-content-end mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary me-2">Voltar</a>
                    <a asp-action="Editar" asp-route-id="@Model.Id" class="btn btn-secondary me-2">Editar</a>
                    <a asp-action="Excluir" asp-route-id="@Model.Id" class="btn btn-danger">Excluir</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===================== MODAL REDEFINIR SENHA ===================== -->
<div class="modal fade" id="modalRedefinirSenha" tabindex="-1" aria-labelledby="modalRedefinirSenhaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRedefinirSenhaLabel">Confirmar Redefinição de Senha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza de que deseja gerar uma nova senha e enviá-la para <strong>@Model.Email</strong>?</p>
                <p class="text-muted small">O utilizador <strong>@Model.Nome</strong> receberá a nova senha no seu e-mail.</p>
            </div>
            <div class="modal-footer">
                <form asp-action="RedefinirSenha" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Sim, Redefinir Senha</button>
                </form>
            </div>
        </div>
    </div>
</div>
