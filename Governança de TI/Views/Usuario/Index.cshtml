@model IEnumerable<Governança_de_TI.Models.UsuarioModel>

@{
    ViewData["Title"] = "Usuários";

    // ====================================================================
    // 1. LÊ E REMOVE as mensagens para que o _Layout não as mostre.
    // Esta página terá seu próprio tratamento de alertas.
    // ====================================================================
    var localSuccessMessage = TempData["SuccessMessage"] as string;
    var localErrorMessage = TempData["ErrorMessage"] as string;

    // Garante que o _Layout.cshtml (que roda depois) não veja estas chaves
    if (localSuccessMessage != null) { TempData.Remove("SuccessMessage"); }
    if (localErrorMessage != null) { TempData.Remove("ErrorMessage"); }
}
<link rel="stylesheet" href="~/css/theme.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Index.css" asp-append-version="true" />
<div class="tg-container">

    <!-- ALERTAS AJAX -->
    <div id="ajax-success-alert-placeholder"></div>

    @if (!string.IsNullOrEmpty(localSuccessMessage))
    {
        <div class="tg-alert tg-alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>@localSuccessMessage
        </div>
    }
    @if (!string.IsNullOrEmpty(localErrorMessage))
    {
        <div class="tg-alert tg-alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@localErrorMessage
        </div>
    }

    <!-- CARD PRINCIPAL -->
    <div class="tg-card">

        <!-- CABEÇALHO -->
        <div class="tg-header">
            <h4 class="tg-title">
                <i class="bi bi-people-fill me-2"></i> Lista de Usuários
            </h4>

            <button id="btnNovoUsuario" type="button" class="tg-btn-primary">
                <i class="bi bi-plus-lg me-2"></i> Novo Usuário
            </button>
        </div>

        <!-- TABELA -->
        <div class="tg-table-wrapper">
            <table class="tg-table">
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Departamento</th>
                        <th>Perfil</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            var fotoSrc = !string.IsNullOrEmpty(item.CaminhoFotoPerfil)
                            ? Url.Content(item.CaminhoFotoPerfil)
                            : Url.Content("~/img/default-user.png");

                            <tr>
                                <td>
                                    <img src="@fotoSrc" class="tg-avatar">
                                </td>

                                <td class="fw-semibold">@item.Nome</td>

                                <td class="tg-muted">@item.Email</td>

                                <td>@(item.Departamento?.Nome ?? "-")</td>

                                <td>
                                    <span class="tg-chip tg-chip-gray">@item.Perfil</span>
                                </td>

                                <td>
                                    @if (item.Status == "Ativo")
                                    {
                                        <span class="tg-chip tg-chip-green">Ativo</span>
                                    }
                                    else
                                    {
                                        <span class="tg-chip tg-chip-red">Inativo</span>
                                    }
                                </td>

                                <td>
                                    <div class="tg-actions">
                                        <button type="button" class="tg-action-btn blue btn-editar-usuario" title="Editar"
                                                data-usuario-id="@item.Id">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button type="button" class="tg-action-btn gray btn-detalhes-usuario"
                                                data-usuario-id="@item.Id" title="Detalhes">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <button type="button" class="tg-action-btn red btn-excluir-usuario"
                                                data-usuario-id="@item.Id" title="Excluir">
                                            <i class="bi bi-trash3"></i>
                                        </button>

                                        <form asp-action="RedefinirSenha" asp-route-id="@item.Id"
                                              method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="tg-action-btn yellow btn-redefinir-senha"
                                                    title="Redefinir Senha">
                                                <i class="bi bi-key"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="tg-empty">
                                <i class="bi bi-info-circle me-2"></i> Nenhum usuário encontrado.
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>

    </div>

</div>

 <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-semibold text-muted" id="userModalLabel">Carregando...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" id="btnConfirmarModalPrincipal"
                        class="btn btn-primary px-4"
                        style="background-color:#8A2BE2;border-color:#8A2BE2;">
                    Salvar
                </button>
            </div>
        </div>
    </div>
</div> 

<div class="modal fade" id="departamentoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-semibold">Novo Departamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="departamentoModalBody">
                Carregando...
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarDepartamento"
                        style="background:#8A2BE2;border-color:#8A2BE2;">
                    Salvar
                </button>
            </div>
        </div>
    </div>
</div>


<style>

    /* ==========================================================
       TECHGREEN - INDEX USUÁRIOS (COMPATÍVEL COM DARK MODE)
       ========================================================== */

    /* CONTAINER */
    .tg-container {
        padding: 20px;
    }

    /* CARD PRINCIPAL */
    .tg-card {
        background: var(--tg-card-bg) !important;
        border-radius: 18px;
        padding: 25px;
        border: 1px solid var(--tg-border) !important;
        color: var(--tg-text) !important;
    }

    /* CABEÇALHO */
    .tg-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .tg-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--tg-text) !important;
    }

    /* BOTÃO NOVO */
    .tg-btn-primary {
        background: var(--tg-primary) !important;
        color: #fff !important;
        border: none;
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 500;
        transition: .2s;
    }

        .tg-btn-primary:hover {
            background: var(--tg-primary-hover) !important;
            transform: scale(1.03);
        }

    /* TABELA WRAPPER */
    .tg-table-wrapper {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--tg-border) !important;
        background: var(--tg-card-bg) !important;
    }

    /* TABELA */
    .tg-table {
        width: 100%;
        border-collapse: collapse;
        color: var(--tg-text) !important;
    }

        /* HEAD */
        .tg-table thead {
            background: var(--tg-sidebar-hover) !important;
        }

            .tg-table thead th {
                padding: 14px;
                font-weight: 600;
                color: var(--tg-text) !important;
                text-transform: uppercase;
                font-size: 12px;
                border-bottom: 1px solid var(--tg-border) !important;
            }

        /* LINHAS */
        .tg-table tbody tr {
            background: var(--tg-card-bg) !important;
            transition: 0.15s ease;
        }

            .tg-table tbody tr:hover {
                background: var(--tg-sidebar-hover) !important;
            }

    /* FOTO */
    .tg-avatar {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid var(--tg-border) !important;
        transition: .2s;
    }

        .tg-avatar:hover {
            transform: scale(1.08);
        }

    /* TEXTO SECUNDÁRIO */
    .tg-muted {
        color: #9c9ca5 !important;
    }

    /* CHIPS */
    .tg-chip {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .tg-chip-gray {
        background: rgba(150,150,180,0.15) !important;
        color: var(--tg-text) !important;
    }

    .tg-chip-green {
        background: rgba(63,185,80,0.18) !important;
        color: #3fb950 !important;
    }

    .tg-chip-red {
        background: rgba(255,80,80,0.20) !important;
        color: #ff6e6e !important;
    }

    /* AÇÕES */
    .tg-actions {
        display: flex;
        gap: 6px;
        justify-content: center;
    }

    .tg-action-btn {
        width: 34px;
        height: 34px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 10px;
        cursor: pointer;
        transition: .15s;
        border: none !important;
    }

        .tg-action-btn:hover {
            transform: scale(1.12);
            opacity: .9;
        }

        .tg-action-btn.blue {
            background: rgba(0,123,255,0.18) !important;
            color: #6db7ff !important;
        }

        /* BOTÃO CINZA – VISUALIZAR */
        .tg-action-btn.gray {
            color: var(--tg-text) !important;
            background: var(--tg-sidebar-hover) !important;
        }
    /* DARK MODE – BOTÃO CINZA */
    :root[data-bs-theme="dark"] .tg-action-btn.gray {
        background: rgba(255,255,255,0.10) !important;
        color: #e2e2e9 !important;
    }

        .tg-action-btn.red {
            background: rgba(255,0,0,0.20) !important;
            color: #ff6e6e !important;
        }

        .tg-action-btn.yellow {
            background: rgba(255,193,7,0.25) !important;
            color: #ffd369 !important;
        }

    /* LINHA VAZIA */
    .tg-empty {
        padding: 30px;
        color: var(--tg-text) !important;
        text-align: center;
        opacity: .6;
    }

</style>

@section Scripts {
    <script>
        $(function () {

            // ============================================================
            // REFERÊNCIAS DO MODAL PRINCIPAL DE USUÁRIO
            // ============================================================
            const userModalEl = document.getElementById('userModal');
            const userModal = bootstrap.Modal.getOrCreateInstance(userModalEl);
            const $modalBody = $('#userModal .modal-body');
            const $submitButton = $('#btnConfirmarModalPrincipal');
            const $userModalLabel = $('#userModalLabel');

            // ============================================================
            // FUNÇÃO DE PERMISSÃO
            // ============================================================
            function validarPermissao(tipo, callback) {
                $.get('@Url.Action("ValidarPermissao", "Usuario")?tipo=' + tipo)
                    .done(res => {
                        if (!res.autorizado) {
                            showDanger(res.message);
                            return;
                        }
                        callback();
                    })
                    .fail(() => showDanger("Erro ao validar permissão."));
            }

            // ============================================================
            // ALERTA DE ERRO
            // ============================================================
            function showDanger(msg) {
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show mt-3 shadow-sm" role="alert">
                        <i class="bi bi-x-circle-fill me-2"></i>${msg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;

                $('#ajax-success-alert-placeholder').html(alertHtml);
                setTimeout(() => $('.alert').alert('close'), 4000);
            }

            // ============================================================
            // ALERTA DE SUCESSO
            // ============================================================
            function showSuccess(msg) {
                const html = `
                    <div class="alert alert-success alert-dismissible fade show mt-3 shadow-sm" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i>${msg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;

                $('#ajax-success-alert-placeholder').html(html);
                setTimeout(() => $('.alert').alert('close'), 3500);
            }

            // ============================================================
            // REINICIALIZAR VALIDAÇÃO
            // ============================================================
            function reinicializarValidacao(selector) {
                const $form = $(selector);
                $form.removeData('validator').removeData('unobtrusiveValidation');

                if ($.validator && $.validator.unobtrusive)
                    $.validator.unobtrusive.parse($form);
            }

            // ============================================================
            // ABRIR MODAL COM LOADER
            // ============================================================
            function abrirModalCarregando(titulo) {
                $userModalLabel.text(titulo);
                $modalBody.html(loaderHtml());
                userModal.show();
            }

            function abrirModalCarregandoDanger(titulo) {
                $userModalLabel.text(titulo);
                $modalBody.html(loaderHtmlDanger());
                userModal.show();
            }

            function loaderHtml() {
                return `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3 text-muted">Carregando...</p>
                </div>`;
            }

            function loaderHtmlDanger() {
                return `
                <div class="text-center p-5">
                    <div class="spinner-border text-danger"></div>
                    <p class="mt-3 text-muted">Carregando...</p>
                </div>`;
            }

            function errorHtml(msg) {
                return `<div class="alert alert-danger m-3"><strong>Erro:</strong> ${msg}</div>`;
            }

            // ============================================================
            // 🔥 NOVO USUÁRIO
            // ============================================================
            $('#btnNovoUsuario').on('click', function () {

                validarPermissao("CriarUsuario", function () {

                    abrirModalCarregando("Novo Usuário");

                    $submitButton.attr('form', 'formCriarUsuario')
                        .text('Salvar')
                        .show()
                        .prop('disabled', true);

                    $.get('@Url.Action("_CriarUsuarioPartial", "Usuario")')
                        .done(data => {
                            $modalBody.hide().html(data).fadeIn(200);
                            $submitButton.prop('disabled', false);
                            reinicializarValidacao('#formCriarUsuario');
                        })
                        .fail(() => {
                            $modalBody.html(errorHtml("Erro ao carregar formulário."));
                            $submitButton.hide();
                        });
                });
            });

            // ============================================================
            // 🔥 EDITAR, DETALHES, EXCLUIR, REDEFINIR SENHA
            // ============================================================
            $(document).on('click', '.btn-editar-usuario', function () {
                const id = $(this).data('usuario-id');

                validarPermissao("EditarUsuario", function () {
                    abrirModalCarregando("Editar Usuário");

                    $submitButton.attr('form', 'formEditarUsuario')
                        .text('Salvar Alterações')
                        .show()
                        .prop('disabled', true);

                    $.get('@Url.Action("_EditarUsuarioPartial", "Usuario")/' + id)
                        .done(data => {
                            $modalBody.hide().html(data).fadeIn(200);
                            $submitButton.prop('disabled', false);
                            reinicializarValidacao('#formEditarUsuario');
                        })
                        .fail(() => {
                            $modalBody.html(errorHtml("Erro ao carregar dados."));
                            $submitButton.hide();
                        });
                });
            });

            $(document).on('click', '.btn-detalhes-usuario', function () {
                const id = $(this).data('usuario-id');

                validarPermissao("DetalhesUsuario", function () {

                    abrirModalCarregando("Detalhes do Usuário");
                    $submitButton.hide();

                    $.get('@Url.Action("_DetalhesUsuarioPartial", "Usuario")/' + id)
                        .done(data => {
                            $modalBody.hide().html(data).fadeIn(200);
                        })
                        .fail(() => {
                            $modalBody.html(errorHtml("Erro ao carregar detalhes."));
                        });
                });
            });

            $(document).on('click', '.btn-excluir-usuario', function () {
                const id = $(this).data('usuario-id');

                validarPermissao("ExcluirUsuario", function () {

                    abrirModalCarregandoDanger("Excluir Usuário");

                    $submitButton.attr('form', 'formExcluirUsuario')
                        .text('Confirmar Exclusão')
                        .removeClass('btn-primary')
                        .addClass('btn-danger')
                        .show()
                        .prop('disabled', true);

                    $.get('@Url.Action("_ExcluirUsuarioPartial", "Usuario")/' + id)
                        .done(data => {
                            $modalBody.hide().html(data).fadeIn(200);
                            $submitButton.prop('disabled', false);
                        })
                        .fail(() => {
                            $modalBody.html(errorHtml("Erro ao carregar confirmação."));
                            $submitButton.hide();
                        });
                });
            });

            $(document).on('click', '.btn-redefinir-senha', function (e) {
                e.preventDefault();

                const form = $(this).closest("form");

                validarPermissao("RedefinirSenha", function () {
                    form.submit();
                });
            });

            // ============================================================
            // SUBMISSÃO AJAX
            // ============================================================
            $(document).on('submit', '#formCriarUsuario, #formEditarUsuario, #formExcluirUsuario', function (e) {

                e.preventDefault();
                const form = $(this);
                const isDelete = form.attr('id') === 'formExcluirUsuario';
                const formData = new FormData(this);

                $submitButton.prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm"></span> Processando...');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: result => {

                        if (result.redirectTo) {
                            showSuccess(result.message || 'Operação concluída!');
                            setTimeout(() => window.location.href = result.redirectTo, 1800);
                        } else {
                            $modalBody.html(result);
                            $submitButton.prop('disabled', false)
                                .text(isDelete ? 'Confirmar Exclusão' : 'Salvar');
                        }
                    },
                    error: jqXHR => {
                        const msg = jqXHR.responseJSON?.message || 'Erro inesperado.';
                        $modalBody.html(errorHtml(msg));
                        $submitButton.prop('disabled', false).text('Tentar novamente');
                    }
                });
            });

            // ============================================================
            // PREVIEW IMAGEM
            // ============================================================
            $(document).on('change', '#inputImagemModal, #inputImagemModalEditar', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const preview = (e.target.id === 'inputImagemModalEditar')
                    ? '#previewImagemModalEditar'
                    : '#previewImagemModal';

                const reader = new FileReader();
                reader.onload = ev => {
                    $(preview)
                        .attr('src', ev.target.result)
                        .css('transform', 'scale(1.05)')
                        .addClass('border border-2 border-primary shadow-sm');

                    setTimeout(() => $(preview).css('transform', 'scale(1)'), 200);
                };
                reader.readAsDataURL(file);
            });

            // ============================================================
            // 🔥 MODAL DE DEPARTAMENTO (CORRIGIDO)
            // ============================================================
            $(document).on("click", "#btnAddDepartamento", function () {

                const modalEl = document.getElementById("departamentoModal");
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

                const body = $("#departamentoModalBody");
                const btnSalvar = $("#btnSalvarDepartamento");

                body.html(`
                    <div class='text-center p-4'>
                        <div class='spinner-border text-primary'></div>
                        <p class='mt-3 text-muted'>Carregando...</p>
                    </div>`);

                modal.show();

                $.get("/Departamento/_CriarDepartamentoModal")
                    .done(data => {
                        body.hide().html(data).fadeIn(150);
                    })
                    .fail(() => {
                        body.html("<div class='alert alert-danger'>Erro ao carregar formulário.</div>");
                    });

                btnSalvar.off("click").on("click", function () {

                    const form = $("#formCriarDepartamento");

                    $.ajax({
                        url: form.attr("action"),
                        method: "POST",
                        data: form.serialize(),
                        success: function (res) {

                            if (res.sucesso) {

                                const select = $("#DepartamentoId");

                                if (select.find("option[value='" + res.departamento.id + "']").length === 0) {
                                    select.append(`<option value='${res.departamento.id}'>${res.departamento.nome}</option>`);
                                }

                                select.val(res.departamento.id).trigger("change");

                                modal.hide();
                            }
                            else {
                                body.html(res);
                            }
                        }
                    });
                });
            });

        }); // fim document ready



        // ============================================================
        // 🔥 CORREÇÃO FINAL: REMOVE BACKDROP FANTASMA
        // ============================================================
        $(document).on("hidden.bs.modal", "#departamentoModal", function () {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
        });

    </script>
}
