@using Governança_de_TI.Models.TecgreenModels
@model List<DescarteModel>

@{
    ViewData["Title"] = "Consulta de Descarte";
}

<!-- ===== CONTEÚDO PRINCIPAL ===== -->
<div class="content-wrapper">
    <!-- ===== FORMULÁRIO DE FILTRO ===== -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 text-muted fw-semibold">
                    <i class="bi bi-hdd-stack me-2"></i>Gestão de Descarte
                </h4>

                <!-- BOTÃO DE NOVO REGISTRO (AGORA CARREGA VIA MODAL DINÂMICA) -->
                <a href="@Url.Action("Criar", "Descarte")"
                   class="btn btn-primary js-open-descarte-modal"
                   data-title="Novo Descarte Sustentável"
                   style="background-color:#8A2BE2;border-color:#8A2BE2;">
                    <i class="bi bi-plus-lg me-2"></i> Novo Registro
                </a>
            </div>

            <form asp-action="Consulta" method="get">
                <div class="row g-3">
                    <div class="col-md-4"><label class="form-label">ID</label><input type="text" name="ID" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">Equipamento (ID ou Nome)</label><input type="text" name="equipamento" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">Empresa Coletora</label><input type="text" name="empresaColetora" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">CNPJ</label><input type="text" name="cnpj" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">Responsável</label><input type="text" name="responsavel" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">Data da Coleta</label><input type="date" name="dataColeta" class="form-control form-control-sm" /></div>
                    <div class="col-md-4"><label class="form-label">Data de Cadastro</label><input type="date" name="dataCadastro" class="form-control form-control-sm" /></div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-select form-select-sm">
                            <option value="">Todos...</option>
                            <option>Pendente</option>
                            <option>Coletado</option>
                            <option>Reciclado</option>
                            <option>Doado</option>
                        </select>
                    </div>
                    <div class="col-md-5"><label class="form-label">Observação</label><input type="text" name="observacao" class="form-control form-control-sm" /></div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" style="background-color: #8A2BE2; border-color: #8A2BE2;">
                            <i class="bi bi-search me-2"></i>Consultar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== TABELA DE RESULTADOS ===== -->
    <div class="card shadow-sm table-card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Equipamento</th>
                            <th>Quantidade</th>
                            <th>Data da Coleta</th>
                            <th>Empresa Coletora</th>
                            <th>Responsável</th>
                            <th>Data de Cadastro</th>
                            <th>Status</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.Id</td>
                                    <td>@($"{item.Equipamento?.CodigoItem} - {item.Equipamento?.Descricao}")</td>
                                    <td>@item.Quantidade</td>
                                    <td>@item.DataColeta.ToShortDateString()</td>
                                    <td>@item.EmpresaColetora</td>
                                    <td>@item.PessoaResponsavelColeta</td>
                                    <td>@item.DataDeCadastro.ToShortDateString()</td>
                                    <td>@item.Status</td>
                                    <td class="text-center">
                                        <!-- DETALHES -->
                                        <a href="@Url.Action("Detalhes", "Descarte", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-secondary border-0 js-open-descarte-modal"
                                           data-title="Detalhes do Descarte #@item.Id"
                                           title="Detalhes">
                                            <i class="bi bi-search"></i>
                                        </a>

                                        <!-- EDITAR -->
                                        <a href="@Url.Action("Editar", "Descarte", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-secondary border-0 js-open-descarte-modal"
                                           data-title="Editar Descarte #@item.Id"
                                           title="Editar">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>

                                        <!-- EXCLUIR -->
                                        <a href="@Url.Action("Excluir", "Descarte", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-danger border-0 js-open-descarte-modal"
                                           data-title="Excluir Descarte #@item.Id"
                                           title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="9" class="text-center py-4">Nenhum registro de descarte encontrado.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL GLOBAL PARA OS DESCARTES ===== -->
<div class="modal fade" id="descarteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow border-0 rounded-4">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-semibold text-dark" id="descarteModalTitle">
                    <i class="bi bi-recycle text-success me-2"></i>Descarte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="descarteModalBody">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3 mb-0 small">Carregando conteúdo…</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const modalEl = document.getElementById('descarteModal');
            const modalBody = document.getElementById('descarteModalBody');
            const modalTitle = document.getElementById('descarteModalTitle');
            const bsModal = new bootstrap.Modal(modalEl);
            const hasLoader = typeof showLoader === 'function' && typeof hideLoader === 'function';

            // === Clique nos botões de modal ===
            document.addEventListener('click', async (ev) => {
                const a = ev.target.closest('.js-open-descarte-modal, .js-open-detalhes-descarte');
                if (!a) return;

                ev.preventDefault();

                const url = a.getAttribute('href');
                const title = a.dataset.title || 'Descarte Sustentável';
                if (!url) return;

                try {
                    hasLoader && showLoader();

                    modalTitle.textContent = title;
                    modalBody.innerHTML = `
                        <div class="p-5 text-center text-muted">
                            <div class="spinner-border text-primary me-2"></div>
                            Carregando conteúdo…
                        </div>`;

                    // === CHAMADA AJAX COM HEADER ===
                    const resp = await fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'text/html'
                        }
                    });

                    const html = await resp.text();

                    // === INJETA O HTML NO MODAL ===
                           modalBody.innerHTML = html;

        // === Após carregar a partial, iniciar scripts específicos ===
                     if (typeof inicializarEventosCriarDescarte === 'function') 
                     {
                        console.log("🔄 Inicializando JS da tela de CRIAR...");
                         inicializarEventosCriarDescarte();
                     }

                    // ================================
                    // 🔥 EXECUTA OS SCRIPTS DA PARTIAL
                    // ================================
                    const scripts = modalBody.querySelectorAll("script");
                    scripts.forEach((oldScript) => {
                        const newScript = document.createElement("script");

                        if (oldScript.src) {
                            newScript.src = oldScript.src;
                        } else {
                            newScript.textContent = oldScript.textContent;
                        }

                        document.body.appendChild(newScript);
                        oldScript.remove();
                    });
                    // ================================

                    // Reativa validação jQuery
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                        $.validator.unobtrusive.parse(modalBody);
                    }

                    // Pequeno delay para animação
                    await new Promise(resolve => setTimeout(resolve, 150));

                    // Abre a modal
                    bsModal.show();

                    // Ajuste de tamanho
                    setTimeout(() => {
                        const modalDialog = modalEl.querySelector('.modal-dialog');
                        if (modalDialog) modalDialog.classList.add('modal-xxl');
                    }, 300);

                } catch (e) {
                    console.error("Erro ao carregar modal:", e);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger m-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Erro ao carregar o conteúdo do modal.
                        </div>`;
                } finally {
                    hasLoader && hideLoader();
                }
            });

            // === Fecha alertas de sucesso ===
            setTimeout(() => {
                const alert = document.getElementById('success-alert');
                if (alert) new bootstrap.Alert(alert).close();
            }, 4000);
        })();

        document.addEventListener('change', async function (e) {

            if (e.target.id !== "EquipamentoId") return;

            const id = e.target.value;
            const descricaoInput = document.getElementById('Descricao');
            const imagePreview = document.getElementById('imagePreview');
            const placeholder = "/img/default-equip.png";

            if (!id) {
                descricaoInput.value = "";
                imagePreview.src = placeholder;
                return;
            }

            try {
                const response = await fetch(`/Equipamentos/GetEquipamentoDados?id=${id}`);
                const data = await response.json();

                descricaoInput.value = data.descricao || "";
                imagePreview.src = data.imageUrl || placeholder;

            } catch (err) {
                console.error("Erro ao carregar dados:", err);
                descricaoInput.value = "";
                imagePreview.src = placeholder;
            }
        });
    </script>
}

