@model Governança_de_TI.Models.DescarteModel

<form id="formCriarDescarte" asp-controller='Descarte' asp-action="Criar" method="post" enctype="multipart/form-data" class="p-3">

    @Html.AntiForgeryToken()
    <div asp-validation-summary="All" class="text-danger small mb-3"></div>

    <div class="row">
        <!-- ===== Coluna Esquerda ===== -->
        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="EquipamentoId" class="form-label text-muted small">
                    <i class="bi bi-cpu me-1"></i>Equipamento
                </label>
                <select asp-for="EquipamentoId" class="form-select shadow-sm" asp-items="ViewBag.EquipamentoId">
                </select>
                <span asp-validation-for="EquipamentoId" class="text-danger small"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Descricao" class="form-label text-muted small">
                    <i class="bi bi-info-circle me-1"></i>Descrição
                </label>
                <input asp-for="Descricao" id="Descricao" class="form-control shadow-sm" readonly />
            </div>

            <div class="mb-3">
                <label asp-for="Observacao" class="form-label text-muted small">
                    <i class="bi bi-journal-text me-1"></i>Observação
                </label>
                <textarea asp-for="Observacao" class="form-control shadow-sm" rows="2"></textarea>
            </div>

            <div class="row">
                <div class="col-sm-6 mb-3">
                    <label asp-for="Quantidade" class="form-label text-muted small">Quantidade</label>
                    <input asp-for="Quantidade" class="form-control shadow-sm" type="number" min="1" />
                    <span asp-validation-for="Quantidade" class="text-danger small"></span>
                </div>

                <div class="col-sm-6 mb-3">
                    <label asp-for="DataColeta" class="form-label text-muted small">Data de Coleta</label>
                    <input asp-for="DataColeta" class="form-control shadow-sm" type="date" />
                    <span asp-validation-for="DataColeta" class="text-danger small"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="EmpresaColetora" class="form-label text-muted small">Empresa Coletora</label>
                <input asp-for="EmpresaColetora" class="form-control shadow-sm" />
                <span asp-validation-for="EmpresaColetora" class="text-danger small"></span>
            </div>

            <div class="row">
                <div class="col-sm-6 mb-3">
                    <label asp-for="CnpjEmpresa" class="form-label text-muted small">CNPJ da Empresa</label>
                    <input asp-for="CnpjEmpresa" class="form-control shadow-sm" />
                </div>
                <div class="col-sm-6 mb-3">
                    <label asp-for="EmailEmpresa" class="form-label text-muted small">E-mail da Empresa</label>
                    <input asp-for="EmailEmpresa" class="form-control shadow-sm" />
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="PessoaResponsavelColeta" class="form-label text-muted small">Responsável pela Coleta</label>
                <input asp-for="PessoaResponsavelColeta" class="form-control shadow-sm" />
            </div>

            <div class="mb-3">
                <label asp-for="Status" class="form-label text-muted small">Status</label>
                <select asp-for="Status" class="form-select shadow-sm">
                    <option value="">Selecione...</option>
                    <option>Pendente</option>
                    <option>Coletado</option>
                    <option>Reciclado</option>
                    <option>Doado</option>
                </select>
            </div>

            <div class="mb-3">
                <label asp-for="CertificadoUpload" class="form-label text-muted small">Certificado (PDF opcional)</label>
                <input asp-for="CertificadoUpload" class="form-control form-control-sm shadow-sm" type="file" />
            </div>

            <div class="form-check mb-3">
                <input asp-for="EnviarEmail" class="form-check-input" type="checkbox" />
                <label asp-for="EnviarEmail" class="form-check-label small text-muted">
                    Enviar e-mail de confirmação à empresa
                </label>
            </div>
        </div>

        <!-- ===== Coluna Direita: Imagem ===== -->
        <div class="col-md-6 d-flex flex-column align-items-center justify-content-start">
            <label class="form-label text-muted small mb-2">
                <i class="bi bi-image me-1"></i>Imagem do Equipamento
            </label>

            <div class="border rounded-4 p-1 bg-light d-flex align-items-center justify-content-center mb-3"
                 style="width: 250px; height: 250px; overflow: hidden;">
                <img id="imagePreview"
                     src="/img/default-equip.png"
                     alt="Pré-visualização da Imagem"
                     class="img-fluid rounded"
                     style="max-width: 100%; max-height: 100%; object-fit: cover;" />
            </div>

            <small class="text-muted small">A imagem será carregada automaticamente ao escolher o equipamento.</small>
        </div>
    </div>

    <hr class="my-3" />

    <div class="d-flex justify-content-end">
        <button type="button"
                class="btn btn-outline-secondary px-4 me-2"
                data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
        </button>

        <button type="submit"
                class="btn btn-primary px-4"
                style="background-color: #8A2BE2; border-color: #8A2BE2;">
            <i class="bi bi-save me-2"></i>Salvar
        </button>
    </div>
</form>

<!-- ===== SCRIPT: Atualiza Descrição e Imagem ===== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const equipamentoSelect = document.getElementById('EquipamentoId');
        const imagePreview = document.getElementById('imagePreview');
        const descricaoInput = document.getElementById('Descricao');
        const placeholderImg = '/img/default-equip.png';

        if (!equipamentoSelect) return;

        equipamentoSelect.addEventListener('change', async function () {
            const equipamentoId = this.value;

            if (!equipamentoId) {
                descricaoInput.value = '';
                imagePreview.src = placeholderImg;
                return;
            }

            try {
                const response = await fetch(`/Equipamentos/GetEquipamentoDados?id=${equipamentoId}`);
                if (!response.ok) throw new Error('Erro ao buscar dados do equipamento');

                const data = await response.json();
                if (!data) return;

                // Atualiza descrição
                descricaoInput.value = data.descricao || '';

                // Atualiza imagem
                if (data.imageUrl) {
                    const path = data.imageUrl.startsWith('/') ? data.imageUrl : '/' + data.imageUrl;
                    imagePreview.src = path;
                } else {
                    imagePreview.src = placeholderImg;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do equipamento:', error);
                descricaoInput.value = '';
                imagePreview.src = placeholderImg;
            }
        });
    });
</script>
