@using Governança_de_TI.Models.Financeiro
@model List<SaldoDiarioModel>
@{
    ViewData["Title"] = "Gerenciamento de Saldos";
    var listaSaldos = Model != null ? Model.ToList() : new List<SaldoDiarioModel>();
}

@section Styles {
    <!-- Fonte Premium -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* === TEMA MODERN FINTECH === */
        :root {
            --bg-app: #F8F9FA;
            --card-bg: #FFFFFF;
            --primary-color: #8B5CF6; /* Roxo principal */
            --primary-dark: #7C3AED;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background-color: var(--bg-app);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
        }

        /* Card Genérico */
        .modern-card {
            background: var(--card-bg);
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 24px;
        }

        /* Inputs Modernos */
        .form-control-modern, .form-select-modern {
            background-color: #fff;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

            .form-control-modern:focus, .form-select-modern:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            }

        .label-modern {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        /* Botões */
        .btn-modern {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-purple {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.3);
        }

            .btn-purple:hover {
                background-color: var(--primary-dark);
                color: white;
                transform: translateY(-1px);
            }

        .btn-warning-soft {
            background-color: #FFF7ED;
            color: #C2410C;
            border: 1px solid #FFEDD5;
        }

            .btn-warning-soft:hover {
                background-color: #FFEDD5;
            }

        .btn-filter {
            background-color: #F3F4F6;
            color: var(--text-primary);
        }

            .btn-filter:hover {
                background-color: #E5E7EB;
            }

        /* Tabela Estilizada */
        .table-custom {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

            .table-custom thead th {
                background-color: #F9FAFB;
                color: var(--text-secondary);
                font-size: 0.75rem;
                font-weight: 700;
                text-transform: uppercase;
                padding: 16px 24px;
                border-bottom: 1px solid #E5E7EB;
            }

            .table-custom tbody td {
                padding: 16px 24px;
                border-bottom: 1px solid #F3F4F6;
                vertical-align: middle;
                font-size: 0.9rem;
            }

            .table-custom tbody tr:last-child td {
                border-bottom: none;
            }

            .table-custom tbody tr:hover {
                background-color: #F9FAFB;
            }

        /* Badges e Cores */
        .badge-account {
            background: #EFF6FF;
            color: #3B82F6;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .text-money-pos {
            color: #059669;
            font-weight: 700;
        }

        .text-money-neg {
            color: #DC2626;
            font-weight: 700;
        }

        .btn-action-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
            transition: 0.2s;
        }

            .btn-action-icon:hover {
                background: #F3F4F6;
                color: var(--primary-color);
                border-color: #E5E7EB;
            }
    </style>
}

<div class="container-fluid px-4 py-4">

    <!-- CABEÇALHO -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <h4 class="fw-bold text-dark mb-1">Gerenciamento de Saldos</h4>
            <small class="text-secondary">Ajuste manual e conferência de saldos diários</small>
        </div>

        <div class="d-flex gap-2">
            <button type="button" class="btn-modern btn-purple" onclick="abrirModalAjuste()">
                <i class="bi bi-pencil-square"></i> Novo Ajuste
            </button>

            <button type="button" class="btn-modern btn-warning-soft" onclick="abrirModalRecalculo()">
                <i class="bi bi-calculator"></i> Recalcular Período
            </button>
        </div>
    </div>

    <!-- CARD DE FILTROS -->
    <div class="modern-card mb-4 p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="label-modern">Conta Bancária</label>
                <select name="idConta" id="filtroIdConta" class="form-select-modern w-100">
                    <option value="">Todas as contas</option>
                    @foreach (var c in ViewBag.Contas)
                    {
                        bool selected = ViewBag.ContaAtual != null && c.IdConta == ViewBag.ContaAtual;
                        <option value="@c.IdConta" selected="@selected">@c.NomeConta (@c.Banco)</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="label-modern">Mês</label>
                <select name="mes" class="form-select-modern w-100">
                    @for (int i = 1; i <= 12; i++)
                    {
                        bool selected = ViewBag.MesAtual == i;
                        <option value="@i" selected="@selected">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="label-modern">Ano</label>
                <input type="number" name="ano" class="form-control-modern w-100" value="@ViewBag.AnoAtual">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn-modern btn-filter w-100">
                    <i class="bi bi-search"></i> Filtrar
                </button>
            </div>
        </form>
    </div>

    <!-- TABELA DE RESULTADOS -->
    <div class="modern-card p-0 overflow-hidden">
        <div class="table-responsive" style="max-height: 600px;">
            <table class="table-custom">
                <thead style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th class="ps-4">Data</th>
                        <th>Conta</th>
                        <th>Saldo Inicial (Dia)</th>
                        <th class="text-end">Saldo Final (Dia)</th>
                        <th class="text-center" style="width: 100px;">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    @if (listaSaldos.Any())
                    {
                        @for (int i = 0; i < listaSaldos.Count; i++)
                        {
                            var item = listaSaldos[i];
                            var colorClass = item.SaldoFinal >= 0 ? "text-money-pos" : "text-money-neg";

                            // Lógica de Saldo Inicial (Mantida)
                            decimal saldoInicialDoDia;
                            if (i < listaSaldos.Count - 1) { saldoInicialDoDia = listaSaldos[i + 1].SaldoFinal; }
                            else { saldoInicialDoDia = item.ContaBancaria.SaldoInicial; }

                            var initialColorClass = saldoInicialDoDia >= 0 ? "text-dark" : "text-danger";

                            <tr>
                                <td class="ps-4 fw-bold text-secondary">
                                    @item.Data.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    <span class="badge-account">
                                        @item.ContaBancaria?.NomeConta
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-semibold @initialColorClass">
                                        @saldoInicialDoDia.ToString("C")
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span class="@colorClass fs-6">
                                        @item.SaldoFinal.ToString("C")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <button class="btn-action-icon mx-auto"
                                            onclick="abrirModalAjuste('@item.IdConta', '@item.Data.ToString("yyyy-MM-dd")', '@item.SaldoFinal.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)')"
                                            title="Editar Saldo Manualmente">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="d-inline-flex bg-light rounded-circle p-3 mb-3">
                                    <i class="bi bi-search fs-3 text-secondary"></i>
                                </div>
                                <h6 class="text-secondary fw-bold">Nenhum registro encontrado</h6>
                                <p class="text-muted small mb-0">Tente alterar os filtros ou clique em Recalcular.</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAIS -->
<!-- Ajuste Manual -->
<div class="modal fade" id="modalAjuste" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Definir Saldo Manual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="SalvarAjuste" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body p-4">
                    <div class="alert alert-warning small border-0 bg-warning bg-opacity-10 text-warning-emphasis mb-4 rounded-3">
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                        Ao alterar este saldo, todos os dias posteriores serão recalculados automaticamente.
                    </div>

                    <div class="mb-3">
                        <label class="label-modern">Conta Bancária</label>
                        <select name="idConta" id="modalIdConta" class="form-select-modern w-100" required>
                            <option value="">Selecione...</option>
                            @foreach (var c in ViewBag.Contas)
                            {
                                <option value="@c.IdConta">@c.NomeConta (@c.Banco)</option>
                            }
                        </select>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <label class="label-modern">Data</label>
                            <input type="date" name="data" id="modalData" class="form-control-modern w-100" required>
                        </div>
                        <div class="col-6">
                            <label class="label-modern">Saldo Final (R$)</label>
                            <input type="number" step="0.01" name="novoSaldo" id="modalValor" class="form-control-modern w-100 fw-bold text-primary" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn-modern btn-filter" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn-modern btn-purple">Salvar Ajuste</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Recálculo -->
<div class="modal fade" id="modalRecalculo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Recalcular Período</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formRecalculo" asp-action="RecalcularPeriodo" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body p-4">
                    <p class="text-secondary small mb-4">
                        O sistema irá reconstruir o saldo dia a dia somando todas as entradas e saídas pagas no período selecionado.
                    </p>

                    <div class="mb-3">
                        <label class="label-modern">Conta Bancária</label>
                        <select name="idConta" id="recalcIdConta" class="form-select-modern w-100" required>
                            @foreach (var c in ViewBag.Contas)
                            {
                                <option value="@c.IdConta">@c.NomeConta (@c.Banco)</option>
                            }
                        </select>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="label-modern">Início</label>
                            <input type="date" name="dataInicio" id="recalcInicio" class="form-control-modern w-100" required>
                        </div>
                        <div class="col-6">
                            <label class="label-modern">Fim</label>
                            <input type="date" name="dataFinal" id="recalcFim" class="form-control-modern w-100" required>
                        </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-link text-decoration-none p-0 text-primary fw-bold" onclick="setMesAtualRecalculo()">
                        <i class="bi bi-calendar-event me-1"></i> Selecionar Mês Atual
                    </button>
                </div>
                <div class="modal-footer border-top-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn-modern btn-filter" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn-modern btn-warning-soft fw-bold">Confirmar Recálculo</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utilitários
        if (typeof window.showFeedbackModal !== 'function') { window.showFeedbackModal = (type, message) => { alert(message); }; }

        // --- LÓGICA DE MODAL ---
        function abrirModalRecalculo() {
            const contaFiltro = document.getElementById('filtroIdConta').value;
            if(contaFiltro) document.getElementById('recalcIdConta').value = contaFiltro;
            setMesAtualRecalculo();
            new bootstrap.Modal(document.getElementById('modalRecalculo')).show();
        }

        function setMesAtualRecalculo() {
            const date = new Date();
            const primeiroDia = new Date(date.getFullYear(), date.getMonth(), 1);
            const ultimoDia = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            const pad = (num) => num.toString().padStart(2, '0');
            const formatDate = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

            document.getElementById('recalcInicio').value = formatDate(primeiroDia);
            document.getElementById('recalcFim').value = formatDate(ultimoDia);
        }

        window.abrirModalAjuste = function(idConta = '', data = '', valor = '') {
             const valorFormatado = valor.replace(/\./g, ',');
             document.getElementById('modalIdConta').value = idConta;
             document.getElementById('modalData').value = data;
             document.getElementById('modalValor').value = valorFormatado;
             new bootstrap.Modal(document.getElementById('modalAjuste')).show();
        }

        // --- SUBMISSÃO AJAX ---
        $('#formRecalculo').on('submit', function(e) {
            e.preventDefault();
            const btn = $(this).find('button[type="submit"]');
            const originalText = btn.html();
            const dados = {
                idConta: $('#recalcIdConta').val(),
                dataInicio: $('#recalcInicio').val(),
                dataFinal: $('#recalcFim').val()
            };
            const token = $('input[name="__RequestVerificationToken"]').val();

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processando...');

            $.ajax({
                url: '/SaldoDiario/RecalcularPeriodo',
                method: 'POST',
                data: dados,
                headers: { "RequestVerificationToken": token },
                success: function(response) {
                    if(response.success) {
                         window.showFeedbackModal('success', response.message);
                         $('#modalRecalculo').modal('hide');
                         setTimeout(() => window.location.reload(), 1500);
                    } else {
                         window.showFeedbackModal('error', response.message);
                         btn.prop('disabled', false).html(originalText);
                    }
                },
                error: function() {
                    window.showFeedbackModal('error', 'Falha na comunicação.');
                    btn.prop('disabled', false).html(originalText);
                }
            });
        });
    </script>
}