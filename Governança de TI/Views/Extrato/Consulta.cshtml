@using Governança_de_TI.DTOs
@using Governança_de_TI.Models
@using System.Globalization
@using System.Linq
@using Governança_de_TI.Models.Financeiro
@model ExtratoViewModel

@{
    ViewData["Title"] = "Fluxo de Caixa";
    var culture = new CultureInfo("pt-BR");
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/css/Extrato.css" rel="stylesheet" />
}
<div class="container-fluid px-3 px-md-4 pb-5 pt-3">

    <!-- BARRA DE FILTROS -->
    <div class="filter-bar">
        
        <!-- Formulário -->
        <form method="get" class="d-flex align-items-center gap-3 filter-form-desktop flex-grow-1" style="max-width: 100%;">
            
            <!-- Navegação de Mês -->
            <div class="d-flex align-items-center bg-light rounded-pill px-2 py-1 border justify-content-between month-nav-container">
                <button type="submit" name="navegar" value="-1" class="btn btn-sm btn-light rounded-circle"><i class="bi bi-chevron-left"></i></button>
                <div class="px-3 fw-bold fs-6 text-capitalize text-center text-nowrap">
                    @Model.DataInicio.ToString("MMMM", culture) <span class="text-muted fw-normal">@Model.DataInicio.Year</span>
                </div>
                <button type="submit" name="navegar" value="1" class="btn btn-sm btn-light rounded-circle"><i class="bi bi-chevron-right"></i></button>
            </div>
            
            <!-- Filtros Rápidos -->
            <div class="d-none d-md-flex gap-2 flex-shrink-0">
                <button type="submit" name="periodo" value="hoje" class="btn-nav-custom @(Model.FiltroPeriodo == "hoje" ? "active" : "")">Hoje</button>
                <button type="submit" name="periodo" value="mes" class="btn-nav-custom @(Model.FiltroPeriodo == "mes" ? "active" : "")">Mês</button>
            </div>

            <!-- Seletor de Data -->
            <div class="date-input-container">
                <i class="bi bi-calendar3 text-muted me-2 d-none d-sm-inline"></i>
                <input type="date" name="dataInicio" class="date-input-clean" value="@Model.DataInicio.ToString("yyyy-MM-dd")">
                <span class="text-muted mx-2 small">até</span>
                <input type="date" name="dataFim" class="date-input-clean" value="@Model.DataFim.ToString("yyyy-MM-dd")">
                <button type="submit" class="btn btn-sm text-primary ms-1 p-0 border-0 bg-transparent"><i class="bi bi-search fs-6"></i></button>
            </div>

        </form>
        
        <!-- Botão Atualizar (Ajustado para "Flutuar" à direita no Desktop) -->
        <button class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm flex-shrink-0 btn-refresh-responsive" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline ms-1">Atualizar</span>
        </button>

    </div>

    <!-- RESTANTE DO LAYOUT (KPIs, LISTA, GRÁFICO) - MANTIDO -->
    <div class="row g-3 mb-4">
        <!-- Saldo Anterior -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="app-card">
                <div class="kpi-card-body">
                    <div>
                        <div class="kpi-header"><div class="kpi-icon-square bg-blue-light"><i class="bi bi-wallet2"></i></div></div>
                        <span class="kpi-label">Saldo Anterior</span>
                        <div class="kpi-value-big text-dark">@Model.SaldoPeriodoAnterior.ToString("C", culture)</div>
                    </div>
                    <div class="kpi-footer-bar"><i class="bi bi-calendar"></i> Até ontem</div>
                </div>
            </div>
        </div>
        <!-- Entradas -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="app-card">
                <div class="kpi-card-body">
                    <div>
                        <div class="kpi-header"><div class="kpi-icon-square bg-green-light"><i class="bi bi-arrow-up-right"></i></div></div>
                        <span class="kpi-label">Entradas</span>
                        <div class="kpi-value-big text-green-modern">@Model.ReceitasPeriodo.ToString("C", culture)</div>
                    </div>
                    <div class="kpi-footer-row">
                        <span class="kpi-status-text text-green-modern"><i class="bi bi-check-circle-fill"></i> Confirmado</span>
                        <span class="kpi-status-value">@Model.ReceitasPeriodo.ToString("C")</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Saídas -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="app-card">
                <div class="kpi-card-body">
                    <div>
                        <div class="kpi-header"><div class="kpi-icon-square bg-red-light"><i class="bi bi-arrow-down-left"></i></div></div>
                        <span class="kpi-label">Saídas</span>
                        <div class="kpi-value-big text-red-modern">@Model.DespesasPeriodo.ToString("C", culture)</div>
                    </div>
                    <div class="kpi-footer-row">
                        <span class="kpi-status-text text-red-modern"><i class="bi bi-exclamation-circle-fill"></i> A Pagar</span>
                        <span class="kpi-status-value">@Model.DespesasPeriodo.ToString("C")</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Previsto -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="app-card">
                <div class="kpi-card-body">
                    <div>
                        <div class="kpi-header"><div class="kpi-icon-square bg-blue-light"><i class="bi bi-piggy-bank"></i></div></div>
                        <span class="kpi-label">Saldo Previsto</span>
                        <div class="kpi-value-big text-blue-modern">@Model.SaldoPrevisto.ToString("C", culture)</div>
                    </div>
                    <div class="kpi-footer-row">
                        <span class="kpi-status-text text-blue-modern"><i class="bi bi-graph-up-arrow"></i> Projetado</span>
                        <span class="kpi-status-value">@Model.SaldoPrevisto.ToString("C")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- LISTA DE TRANSAÇÕES -->
        <div class="col-12 col-xl-8">
            <div class="app-card">
                <div class="d-flex justify-content-between align-items-center p-3 p-md-4 border-bottom">
                    <h5 class="fw-bold mb-0 fs-6 fs-md-5">Transações</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success rounded-pill fw-bold btn-sm px-3 btn-sm-mobile" onclick="abrirModalLancamento(2)">+ <span class="d-none d-md-inline">Receita</span></button>
                        <button class="btn btn-outline-danger rounded-pill fw-bold btn-sm px-3 btn-sm-mobile" onclick="abrirModalLancamento(1)">- <span class="d-none d-md-inline">Despesa</span></button>
                    </div>
                </div>

                <div class="transaction-list-wrapper custom-scroll">
                    @if (Model.Parcelas != null && Model.Parcelas.Any())
                    {
                        foreach (var item in Model.Parcelas)
                        {
                            var pai = item.LancamentoPai;
                            var isReceita = pai.TipoLancamento == 2;
                            var colorClass = isReceita ? "text-success" : "text-danger";
                            var bgIcon = isReceita ? "bg-green-soft" : "bg-red-soft";
                            var iconClass = isReceita ? "bi-arrow-up-right" : "bi-arrow-down-left";
                            var descricao = string.IsNullOrEmpty(pai.Documento) ? "Sem Descrição" : pai.Documento;
                            var nomeCategoria = pai.Tipo?.Nome ?? "Geral";
                            var nomeSub = pai.SubCategoria?.Nome;
                            var textoCategoriaCompleta = string.IsNullOrEmpty(nomeSub) ? nomeCategoria : $"{nomeCategoria}"; 
                            var nomeConta = pai.Conta?.NomeConta ?? "Conta não def.";
                            var formaPagto = string.IsNullOrEmpty(pai.FormaPagamento) ? "N/A" : pai.FormaPagamento;
                            var textoCondicao = "À Vista";
                            var badgeCondicaoClass = "badge-blue";
                            var Pessoa = pai.Pessoa?.Nome ?? "N/A";
                            if (pai.Condicao == 2) {
                                textoCondicao = $"{item.NumeroParcela}/{pai.NumeroParcelas}";
                                badgeCondicaoClass = "badge-purple";
                            }
                            var isPago = item.Status == 2;
                            var statusText = isPago ? "PAGO" : "PENDENTE";
                            var statusClass = isPago ? "status-paid" : "status-pending";

                            <div class="trans-item-modern">
                                <div class="d-flex align-items-center">
                                    <div class="icon-box-lg @bgIcon me-2 me-md-3">
                                        <i class="bi @iconClass"></i>
                                    </div>
                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <h6 class="fw-bold text-dark mb-0 fs-6 text-truncate trans-title" style="max-width: 60%;">@descricao</h6>
                                            <span class="fw-bolder fs-6 fs-md-5 @colorClass trans-value">@item.ValorParcela.ToString("C", culture)</span>
                                        </div>
                                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                            <div class="meta-text text-truncate" title="Categoria"><i class="bi bi-tag-fill text-secondary"></i> @textoCategoriaCompleta</div>
                                            <div class="meta-text d-none d-md-flex" title="Conta"><i class="bi bi-wallet-fill text-secondary"></i> @nomeConta</div>
                                        </div>
                                        <div class="d-flex flex-wrap align-items-center gap-2">
                                            <span class="badge-detail badge-gray d-none d-sm-inline-flex">@formaPagto</span>
                                            @if(pai.Condicao == 2) {
                                                <span class="badge-detail @badgeCondicaoClass">@textoCondicao</span>
                                            }
                                            <span class="badge-detail badge-orange">@item.DataVencimento.ToString("dd/MM")</span>
                                            <span class="status-pill @statusClass ms-auto" style="font-size: 0.65rem;">@statusText</span>
                                        </div>
                                    </div>
                                    <div class="dropdown ms-2">
                                        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                                            <li><button class="dropdown-item" onclick="abrirModalLancamento(0, '@pai.IdLancamento')"><i class="bi bi-pencil me-2"></i> Editar</button></li>
                                            <li><button class="dropdown-item text-danger" onclick="excluirLancamento('@pai.IdLancamento')"><i class="bi bi-trash me-2"></i> Excluir</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5"><i class="bi bi-inbox fs-1 text-muted opacity-25"></i><p class="mt-3 text-muted fw-bold">Nada encontrado</p></div>
                    }
                </div>
            </div>
        </div>

        <!-- PAINEL DIREITO -->
        <div class="col-12 col-xl-4">
            <div class="app-card p-4 h-100">
                 <ul class="nav right-panel-tabs mb-4" id="rightPanelTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" type="button">Análise</button></li>
                    <li class="nav-item"><button class="nav-link" id="contas-tab" data-bs-toggle="tab" data-bs-target="#contas-pane" type="button">Contas</button></li>
                </ul>
                <div class="tab-content">
                     <!-- Gráficos -->
                    <div class="tab-pane fade show active" id="graficos-pane">
                        <div class="chart-toggle">
                            <button class="chart-toggle-btn active expense" onclick="toggleChartData('expense')">Saídas</button>
                            <button class="chart-toggle-btn income" onclick="toggleChartData('income')">Entradas</button>
                        </div>
                        <div class="position-relative mx-auto mb-4" style="height: 200px; width: 200px;">
                            <canvas id="doughnutChart"></canvas>
                            <div class="position-absolute top-50 start-50 translate-middle text-center" style="pointer-events: none;">
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.6rem;" id="chartLabel">Saídas</small>
                                <span class="fw-bolder fs-6 text-dark" id="chartTotal">@Model.DespesasPeriodo.ToString("C0", culture)</span>
                            </div>
                        </div>
                        <div class="custom-scroll pe-2" style="max-height: 280px;" id="categoryListContainer"></div>
                    </div>
                    <!-- Contas -->
                    <div class="tab-pane fade" id="contas-pane">
                        <div class="accounts-list custom-scroll" style="max-height: 400px;">
                            @{ var contas = ViewBag.Contas as List<ContaBancariaModel>; }
                            @if (contas != null && contas.Any())
                            {
                                foreach (var conta in contas)
                                {
                                    var bgBank = conta.Banco.ToLower().Contains("nubank") ? "#820AD1" : "#64748B";
                                    var iniciais = conta.Banco.Length >= 2 ? conta.Banco.Substring(0, 2).ToUpper() : "BK";
                                    <div class="bank-row d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="bank-icon" style="background-color: @bgBank">@iniciais</div>
                                            <div><div class="fw-bold text-dark lh-1">@conta.Banco</div><small class="text-muted">@conta.NomeConta</small></div>
                                        </div>
                                        <div class="fw-bold text-dark">@conta.SaldoAtual.GetValueOrDefault().ToString("C")</div>
                                    </div>
                                }
                            }
                        </div>
                        <div class="mt-3">
                            <a href="/Contas/Consulta" class="btn btn-light w-100 fw-bold text-primary rounded-pill py-2 border shadow-sm">
                                <i class="bi bi-gear-wide-connected me-2"></i> Gerenciar Contas
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="LancamentoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 rounded-4" id="LancamentoModalContent"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('doughnutChart').getContext('2d');

        // Preparar dados (Serializados do C#)
        // Assumindo que seu model tem ReceitasPorCategoria (se não tiver, o gráfico de entradas ficará vazio mas não quebrará)
        // Usei a safe navigation ?. e nullish coalescing ?? para evitar erros.
        const expenseData = {
            labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DespesasPorCategoria?.Keys.ToList() ?? new List<string>())),
            values: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DespesasPorCategoria?.Values.ToList() ?? new List<decimal>())),
            total: '@Model.DespesasPeriodo.ToString("C0", culture)',
            totalLabel: 'Saídas'
        };

        // NOTA: Os dados de ReceitasPorCategoria no seu código C# estão no Model, não no ViewBag, mas para a View funcionar com ambos os casos, mantive a serialização do Model.
        const incomeData = {
            labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReceitasPorCategoria?.Keys.ToList() ?? new List<string>())),
            values: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReceitasPorCategoria?.Values.ToList() ?? new List<decimal>())),
            total: '@Model.ReceitasPeriodo.ToString("C0", culture)',
            totalLabel: 'Entradas'
        };

        const chartColors = ['#3B82F6', '#F59E0B', '#10B981', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#06B6D4'];

        let chartInstance;

        function initChart(dataObj) {
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataObj.labels,
                    datasets: [{
                        data: dataObj.values,
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '82%',
                    plugins: { legend: { display: false } }
                }
            });

            // Atualiza texto central
            document.getElementById('chartLabel').innerText = dataObj.totalLabel;
            document.getElementById('chartTotal').innerText = dataObj.total;

            // Atualiza Lista
            renderCategoryList(dataObj);
        }

        function renderCategoryList(dataObj) {
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = '';

            if(dataObj.labels.length === 0) {
                container.innerHTML = '<div class="text-center text-muted small py-4">Sem dados para exibir</div>';
                return;
            }

            let html = '';
            dataObj.labels.forEach((label, index) => {
                const val = dataObj.values[index];
                // Calcula porcentagem aproximada
                const totalNum = dataObj.values.reduce((a, b) => a + b, 0);
                const pct = totalNum > 0 ? (val / totalNum * 100).toFixed(1) : 0;
                const color = chartColors[index % chartColors.length];

                // Formata moeda (básico)
                const money = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                html += `
                    <div class="category-list-item">
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; border-radius: 4px; background-color: ${color};"></div>
                            <div>
                                <div class="fw-bold text-dark" style="font-size: 0.9rem;">${label}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">${pct}%</div>
                            </div>
                        </div>
                        <span class="fw-bold text-secondary">${money}</span>
                    </div>
                `;
            });
            container.innerHTML = `<div class="d-flex flex-column gap-2">${html}</div>`;
        }

        // Função de Toggle
        window.toggleChartData = function(type) {
            const btns = document.querySelectorAll('.chart-toggle-btn');
            btns.forEach(b => b.classList.remove('active'));

            if(type === 'expense') {
                document.querySelector('.chart-toggle-btn.expense').classList.add('active');
                initChart(expenseData);
            } else {
                document.querySelector('.chart-toggle-btn.income').classList.add('active');
                initChart(incomeData);
            }
        }

        // Inicializa com Despesas
        initChart(expenseData);
        renderCategoryList(expenseData);
        function abrirModalLancamento(tipo, id = null) {
                // Mostra spinner de carregamento
                $('#LancamentoModalContent').html('<div class="p-5 text-center"><div class="spinner-border text-primary"></div></div>');
                $('#LancamentoModal').modal('show');

                // Monta a URL correta para a Controller
                // Ex: /Lancamentos/CriarPartial?tipo=1&id=GUID-AQUI
                let url = `/Lancamentos/CriarPartial?tipo=${tipo}`;

                // Se tiver ID, adiciona na URL (Modo Edição)
                if (id) {
                    url += `&id=${id}`;
                }

                // Carrega o conteúdo via AJAX
                $('#LancamentoModalContent').load(url, function(response, status, xhr) {
                    if (status == "error") {
                        $('#LancamentoModalContent').html('<div class="p-4 text-center text-danger">Erro ao carregar formulário.</div>');
                    }
                });
            }

                   // Função para Excluir (Cancelamento)
        function excluirLancamento(id) {
            if(confirm("Tem certeza que deseja excluir este lançamento? Esta ação irá estornar o saldo se houver pagamentos.")) {
                $.ajax({
                    url: `/api/financeiro/lancamentos/${id}/cancelar`,
                    type: 'PATCH',
                    success: function(res) {
                        if(res.success) {
                            location.reload();
                        } else {
                            alert("Erro: " + res.message);
                        }
                    },
                    error: function(xhr) {
                        let msg = "Erro desconhecido. (Código: " + xhr.status + ").";

                        // --- CORREÇÃO DE TRATAMENTO DE ERRO AQUI ---
                        if (xhr.responseText) {
                            try {
                                // Tenta analisar o texto da resposta
                                let res = JSON.parse(xhr.responseText);
                                msg = res.message || `Erro do Servidor (Status ${xhr.status})`;
                            } catch (e) {
                                // Se falhar a análise JSON (Content-Length: 0 ou malformado)
                                msg = "Falha de comunicação ou Lançamento já cancelado/inconsistente.";
                            }
                        } else if (xhr.status == 400) {
                             // Se o corpo estiver vazio, mas sabemos que 400 é um erro de regra de negócio (já cancelado)
                             msg = "Requisição inválida. O lançamento pode já estar cancelado ou possui dados inconsistentes.";
                        }
                        // --- FIM DA CORREÇÃO ---

                        alert(msg);
                    }
                });
            }
        }

        window.carregarLancamentos = function() { location.reload(); }
    </script>
}