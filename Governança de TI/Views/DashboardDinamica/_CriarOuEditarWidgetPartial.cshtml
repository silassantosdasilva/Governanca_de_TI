@using Governança_de_TI.Models.TecgreenModels
@model DashboardWidgetModel

<form id="form-widget-config" class="needs-validation" novalidate>
    <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold text-muted">
            @((Model.Id == 0 ? "Adicionar" : "Editar") + " Widget (Posição " + Model.Posicao + ")")
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>

    <div class="modal-body p-4">

        <!-- ====== PASSO 1 ====== -->
        <h6 class="fw-semibold text-primary mb-3">PASSO 1: O que exibir?</h6>
        <div class="row g-3">
            <div class="col-md-7">
                <label for="inputTitulo" class="form-label fw-semibold">Título do Widget</label>
                <input id="inputTitulo" type="text" class="form-control" placeholder="Ex: Equipamentos por Status" required>
            </div>
            <div class="col-md-5">
                <label for="selectTipoVisualizacao" class="form-label fw-semibold">Tipo de Visualização</label>
                <select id="selectTipoVisualizacao" class="form-select" required>
                    <option value="">-- Selecione --</option>
                    <option value="Total">Total (KPI)</option>
                    <option value="Pizza">Gráfico de Pizza</option>
                    <option value="Rolo">Gráfico de Rosca</option>
                    <option value="Barra">Gráfico de Barra</option>
                    <option value="Linha">Gráfico de Linha</option>
                    <option value="Lista">Lista / Tabela</option>
                </select>
            </div>
        </div>

        <hr class="my-4" />

        <!-- ====== PASSO 2 ====== -->
        <h6 class="fw-semibold text-primary mb-3">PASSO 2: De onde virão os dados?</h6>
        <div class="mb-3">
            <label for="selectTabela" class="form-label fw-semibold">Tabela Fonte</label>
            <select id="selectTabela" class="form-select" required>
                <option value="">Carregando tabelas...</option>
            </select>
        </div>

        <hr class="my-4" />

        <!-- ====== PASSO 3 ====== -->
        <h6 class="fw-semibold text-primary mb-3">PASSO 3: Como calcular?</h6>

        <div id="grupoConfig" class="config-grupo">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="selectOperacao" class="form-label fw-semibold">Operação</label>
                    <select id="selectOperacao" class="form-select">
                        <option value="Contagem">Contagem</option>
                        <option value="Soma">Soma</option>
                        <option value="Media">Média</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="selectMetrica" class="form-label fw-semibold">Campo Métrica</label>
                    <select id="selectMetrica" class="form-select">
                        <option value="">-- Selecione após escolher tabela --</option>
                    </select>
                </div>

                <div class="col-md-12">
                    <label for="selectDimensao" class="form-label fw-semibold">Agrupar por (Dimensão)</label>
                    <select id="selectDimensao" class="form-select">
                        <option value="">-- Selecione após escolher tabela --</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="grupo-filtros" class="mt-4 p-3 bg-light rounded-3">
            <h6 class="fw-semibold text-muted mb-3">Filtros Opcionais</h6>
            <div class="row g-3">
                <div class="col-md-12">
                    <label for="selectDataFiltro" class="form-label">Campo de Data</label>
                    <select id="selectDataFiltro" class="form-select">
                        <option value="">-- Nenhum filtro --</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="dataInicio" class="form-label">De</label>
                    <input id="dataInicio" type="date" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label for="dataFim" class="form-label">Até</label>
                    <input id="dataFim" type="date" class="form-control" />
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" id="btnSalvarWidget" class="btn btn-primary">Salvar Widget</button>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const form = document.getElementById("form-widget-config");
            const selectTabela = document.getElementById("selectTabela");
            const selectDimensao = document.getElementById("selectDimensao");
            const selectMetrica = document.getElementById("selectMetrica");
            const selectDataFiltro = document.getElementById("selectDataFiltro");
            const selectTipo = document.getElementById("selectTipoVisualizacao");
            const inputTitulo = document.getElementById("inputTitulo");

            let dashboardSchema = {};

            // ============================================================
            // 🔹 1. Carregar Tabelas Dinamicamente via /api/dashboard/schema
            // ============================================================
            async function carregarTabelas() {
                try {
                    const resp = await fetch("/api/dashboard/schema");
                    if (!resp.ok) throw new Error("Falha ao buscar schema do dashboard.");

                    const schema = await resp.json();
                    dashboardSchema = schema;
                    const tabelas = Object.keys(schema);

                    if (!tabelas.length) {
                        selectTabela.innerHTML = "<option value=''>Nenhuma tabela disponível</option>";
                        return;
                    }

                    selectTabela.innerHTML = "<option value=''>-- Selecione uma tabela --</option>";
                    tabelas.forEach(tab => {
                        const opt = document.createElement("option");
                        opt.value = tab;
                        opt.textContent = tab;
                        selectTabela.appendChild(opt);
                    });

                    console.log("📋 Tabelas carregadas:", tabelas);
                } catch (err) {
                    console.error("❌ Erro ao carregar schema:", err);
                    selectTabela.innerHTML = "<option value=''>Erro ao carregar tabelas</option>";

                    // Log opcional
                    await fetch("/api/log/registrar", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            origem: "Dashboard Wizard",
                            tipo: "Erro",
                            mensagem: "Falha ao carregar schema de dashboard",
                            detalhes: err.message
                        })
                    });
                }
            }
            await carregarTabelas();

            // ============================================================
            // 🔹 2. Quando muda a tabela → carregar campos do schema
            // ============================================================
            selectTabela.addEventListener("change", (e) => {
                const tabela = e.target.value;
                if (!tabela || !dashboardSchema[tabela]) return;

                const meta = dashboardSchema[tabela];

                selectDimensao.innerHTML = "<option value=''>-- Dimensão --</option>";
                selectMetrica.innerHTML = "<option value=''>-- Métrica --</option>";
                selectDataFiltro.innerHTML = "<option value=''>-- Nenhum filtro --</option>";

                (meta.CamposDimensao || []).forEach(c =>
                    selectDimensao.insertAdjacentHTML("beforeend", `<option value="${c}">${c}</option>`)
                );
                (meta.CamposMetrica || []).forEach(c =>
                    selectMetrica.insertAdjacentHTML("beforeend", `<option value="${c}">${c}</option>`)
                );
                (meta.CamposData || []).forEach(c =>
                    selectDataFiltro.insertAdjacentHTML("beforeend", `<option value="${c}">${c}</option>`)
                );
            });

            // ============================================================
            // 🔹 3. Salvar Widget (Front-End Only)
            // ============================================================
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const posicao = "@Model.Posicao";
                const tabela = selectTabela.value;
                const tipo = selectTipo.value;
                const titulo = inputTitulo.value;
                const dimensao = selectDimensao.value;
                const metrica = selectMetrica.value;
                const operacao = document.getElementById("selectOperacao").value;

                if (!tabela || !tipo || !titulo) {
                    alert("Preencha os campos obrigatórios!");
                    return;
                }

                const widgetConfig = { posicao, tabela, tipo, titulo, dimensao, metrica, operacao };
                localStorage.setItem(`widget-${posicao}`, JSON.stringify(widgetConfig));

                // Fecha o modal
                const modal = bootstrap.Modal.getInstance(document.querySelector("#widgetWizardModal"));
                if (modal) modal.hide();

                // Renderiza imediatamente se a função existir
                if (typeof carregarWidget === "function") {
                    carregarWidget(tabela, tipo, titulo, dimensao, metrica, operacao);
                }

                console.log("✅ Widget salvo:", widgetConfig);

                // Log opcional
                await fetch("/api/log/registrar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        origem: "Dashboard",
                        tipo: "Info",
                        mensagem: `Widget criado: ${titulo}`,
                        detalhes: JSON.stringify(widgetConfig)
                    })
                });
            });
        });
    </script>
}
