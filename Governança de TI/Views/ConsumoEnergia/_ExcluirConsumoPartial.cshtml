@using Governança_de_TI.Models.TecgreenModels
@model ConsumoEnergiaModel

<form id="formExcluirConsumo"
      asp-action="ExcluirConfirmado"
      asp-controller="ConsumoEnergia"
      method="post"
      class="p-4 text-center">
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.Id)

    <!-- Ícone de alerta -->
    <div class="mb-3">
        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
    </div>

    <!-- Mensagem de confirmação -->
    <h5 class="fw-bold text-dark mb-3">
        Confirmar exclusão do registo de consumo?
    </h5>

    <p class="text-muted mb-4">
        <strong>Mês/Ano:</strong> @Model.DataReferencia.ToString("MM/yyyy")<br />
        <strong>Consumo:</strong> @Model.ValorKwh.ToString("N2") kWh
    </p>

    <!-- Botões -->
    <div class="d-flex justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-danger px-4">
            <i class="bi bi-trash me-2"></i>Excluir
        </button>
    </div>
</form>

@section Scripts {
    <script>
        // === Inicializa o envio AJAX do formulário de exclusão ===
        function initExcluirConsumoForm() {
            const form = document.getElementById('formExcluirConsumo');
            if (!form) return;

            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const formData = new FormData(form);

                try {
                    const resp = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const contentType = resp.headers.get('content-type');

                    // Caso retorno seja sucesso (JSON)
                    if (contentType && contentType.includes('application/json')) {
                        const data = await resp.json();
                        if (data.success) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('energiaModal'));
                            modal.hide();

                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show m-3 shadow-sm';
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                            document.body.prepend(alertDiv);

                            setTimeout(() => location.reload(), 1500);
                        }
                    } else {
                        alert("Erro ao excluir o registro.");
                    }
                } catch (err) {
                    console.error("Erro ao excluir consumo:", err);
                    alert("Erro ao processar exclusão.");
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initExcluirConsumoForm);
    </script>
}
