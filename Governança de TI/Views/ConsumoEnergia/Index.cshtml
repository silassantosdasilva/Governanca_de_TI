@using Governança_de_TI.Models.TecgreenModels
@model IEnumerable<ConsumoEnergiaModel>
@{
    ViewData["Title"] = "Gestão de Consumo de Energia";
}

<!-- ===== CONTEÚDO PRINCIPAL ===== -->
<div class="content-wrapper">
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <!-- Cabeçalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold text-dark mb-0">Gestão de Consumo de Energia</h4>

                <!-- Botão Novo Registro (abre via modal dinâmica) -->
                <a href="@Url.Action("Criar", "ConsumoEnergia")"
                   data-title="Novo Registo de Consumo de Energia"
                   class="btn btn-sm btn-primary js-open-energia-modal"
                   style="background-color: #8A2BE2; border-color: #8A2BE2;">
                    <i class="bi bi-plus-lg me-2"></i>Novo Registo
                </a>
            </div>

            <!-- ===== TABELA DE REGISTROS ===== -->
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Mês / Ano</th>
                            <th>Consumo (kWh)</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.DataReferencia.ToString("MMMM yyyy")</td>
                                    <td>@item.ValorKwh.ToString("N2") kWh</td>
                                    <td class="text-center">
                                        <a href="@Url.Action("Editar", "ConsumoEnergia", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-secondary border-0 js-open-energia-modal"
                                           data-title="Editar Registo de Energia - @item.DataReferencia.ToString("MMMM yyyy")"
                                           title="Editar">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <a href="@Url.Action("Excluir", "ConsumoEnergia", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-danger border-0 js-open-energia-modal"
                                           data-title="Excluir Registo de Energia - @item.DataReferencia.ToString("MMMM yyyy")"
                                           title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">
                                    Nenhum registo de consumo encontrado.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL GLOBAL DE CONSUMO DE ENERGIA ===== -->
<div class="modal fade" id="energiaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow border-0 rounded-4">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-semibold text-dark" id="energiaModalTitle">
                    <i class="bi bi-lightning-charge-fill text-warning me-2"></i>Consumo de Energia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="energiaModalBody">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3 mb-0 small">Carregando conteúdo…</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const modalEl = document.getElementById('energiaModal');
            const modalBody = document.getElementById('energiaModalBody');
            const modalTitle = document.getElementById('energiaModalTitle');
            const bsModal = new bootstrap.Modal(modalEl);

            // === Função para abrir qualquer tela (Criar, Editar, Excluir) via AJAX ===
            document.addEventListener('click', async (ev) => {
                const a = ev.target.closest('.js-open-energia-modal');
                if (!a) return;
                ev.preventDefault();

                const url = a.getAttribute('href');
                const title = a.dataset.title || 'Consumo de Energia';
                if (!url) return;

                try {
                    // Exibe loader temporário
                    modalTitle.textContent = title;
                    modalBody.innerHTML = `
                        <div class="p-5 text-center text-muted">
                            <div class="spinner-border text-primary me-2"></div>
                            Carregando conteúdo…
                        </div>`;

                    // === Requisição AJAX ===
                    const resp = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    // Garante que o retorno seja HTML válido
                    const html = await resp.text();
                    modalBody.innerHTML = html.trim();

                    // Reativa scripts embutidos (form AJAX interno)
                    const scripts = modalBody.querySelectorAll('script');
                    scripts.forEach(scr => {
                        const newScript = document.createElement('script');
                        newScript.textContent = scr.textContent;
                        document.body.appendChild(newScript);
                        scr.remove();
                    });

                    bsModal.show();

                } catch (err) {
                    console.error('Erro ao carregar modal:', err);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger m-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Erro ao carregar o conteúdo da modal.
                        </div>`;
                }
            });

            // === Fecha alertas automaticamente ===
            setTimeout(() => {
                const alert = document.getElementById('success-alert');
                if (alert) new bootstrap.Alert(alert).close();
            }, 4000);
        })();
    </script>
}


