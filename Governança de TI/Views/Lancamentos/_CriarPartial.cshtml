@using Governança_de_TI.DTOs
@using Governança_de_TI.DTOs.Financeiro
@model LancamentoDTO

@{
    Layout = null;
    bool isReceita = Model.TipoLancamento == 2;
    string tipoTexto = isReceita ? "Receita" : "Despesa";
    string corTema = isReceita ? "success" : "danger";
    string iconeTitulo = isReceita ? "bi-graph-up-arrow" : "bi-graph-down-arrow";
}

<style>
    /* === Estilos do App === */
    .modal-content-app {
        border-radius: 24px;
        border: none;
    }

    .modal-header-app {
        border-bottom: none;
        padding: 24px 30px 10px 30px;
        background: #fff;
        border-radius: 24px 24px 0 0;
    }

    .modal-title-app {
        font-weight: 800;
        font-size: 1.3rem;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-label {
        font-size: 0.8rem;
        font-weight: 700;
        color: #9ca3af;
        margin: 25px 0 15px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .section-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .dot-green {
        background-color: #10B981;
    }

    .dot-purple {
        background-color: #8B5CF6;
    }

    .dot-blue {
        background-color: #3B82F6;
    }

    /* Inputs */
    .form-control-app, .form-select-app {
        background-color: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 1rem;
        color: #374151;
        width: 100%;
    }

        .form-control-app:focus, .form-select-app:focus {
            border-color: var(--tg-primary, #8A2BE2);
            box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.1);
            outline: none;
        }

    .form-label-app {
        font-size: 0.9rem;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 6px;
        display: block;
    }

    .input-helper {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 4px;
    }

    /* Status Card */
    .status-card {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

        .status-card:hover {
            background-color: #f9fafb;
        }

        .status-card.active {
            border-color: var(--tg-primary, #8A2BE2);
            background-color: #f5f3ff;
        }

    /* Switch */
    .switch-app {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
        margin-bottom: 0;
    }

        .switch-app input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    /* Slider Padrão (Sem marcar - Pendente) = Vermelho */
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #EF4444;
        transition: .4s;
        border-radius: 34px;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

    /* Slider Marcado (Pago) = Verde */
    input:checked + .slider {
        background-color: #10B981;
    }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

    /* Botões */
    .btn-save-big {
        background-color: @(isReceita ? "#10B981" : "#EF4444");
        color: white;
        border: none;
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        margin-top: 20px;
    }

        .btn-save-big:hover {
            opacity: 0.9;
            color: white;
        }

    .btn-cancel {
        background: #fff;
        border: 1px solid #e5e7eb;
        color: #374151;
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        font-weight: 600;
        margin-top: 12px;
    }

    /* Botão ADD Pequeno */
    .btn-add-mini {
        width: 50px;
        flex-shrink: 0;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: var(--tg-primary, #8A2BE2);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

        .btn-add-mini:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

    /* Scroll Customizado */
    .scroll-container {
        max-height: 60vh !important;
        overflow-y: auto !important;
        overflow-x: hidden;
        padding-right: 10px;
        padding-bottom: 10px;
        margin-right: -5px;
    }

        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

            .scroll-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

    /* Centralização dos Modais Internos */
    .overlay-center {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
</style>

<div class="modal-header modal-header-app">
    <h5 class="modal-title-app">
        <div class="icon-circle bg-@corTema bg-opacity-10 text-@corTema p-2 rounded-circle">
            <i class="bi @iconeTitulo"></i>
        </div>
        Adicionar @tipoTexto
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="formLancamento" class="p-4 pt-0">
    <!-- O Tipo (Receita/Despesa) é importante para salvar a categoria corretamente -->
    <input type="hidden" name="TipoLancamento" value="@(isReceita ? 2 : 1)" />

    <div class="scroll-container">
        <!-- SEÇÃO 1: BÁSICO -->
        <div class="section-label mt-2"><span class="section-dot dot-green"></span> Informações Básicas</div>

        <div class="mb-3">
            <label asp-for="Valor" class="form-label-app">Valor Total</label>
            <input type="number" step="0.01" asp-for="Valor" class="form-control-app" placeholder="0,00" required />
        </div>

        <div class="mb-3">
            <label asp-for="Documento" class="form-label-app">Descrição</label>
            <input type="text" asp-for="Documento" class="form-control-app" placeholder="Ex: Supermercado" required />
        </div>

        <!-- CATEGORIA E SUBCATEGORIA (COM BOTÕES +) -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label asp-for="IdTipo" class="form-label-app">Categoria</label>
                <div class="d-flex gap-2">
                    <select asp-for="IdTipo" class="form-select-app" asp-items="ViewBag.Categorias" onchange="carregarSubcategorias(this.value)">
                        <option value="">Selecione...</option>
                    </select>
                    <button type="button" class="btn-add-mini" onclick="abrirModalCategoria()" title="Nova Categoria">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label-app">Subcategoria</label>
                <div class="d-flex gap-2">
                    <select id="IdSubcategoria" name="IdSubcategoria" class="form-select-app" disabled>
                        <option value="">Selecione a categoria...</option>
                    </select>
                    <button type="button" class="btn-add-mini" onclick="abrirModalSubcategoria()" title="Nova Subcategoria">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- SEÇÃO 2: PAGAMENTO -->
        <div class="section-label"><span class="section-dot dot-blue"></span> Pagamento</div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label-app">Forma</label>
                <select name="FormaPagamento" class="form-select-app">
                    <option value="PIX">PIX</option>
                    <option value="Boleto">Boleto</option>
                    <option value="CartaoCredito">Cartão Crédito</option>
                    <option value="CartaoDebito">Cartão Débito</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="TED">TED</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label-app">Condição</label>
                <select id="condicaoPagamento" name="CondicaoPagamento" class="form-select-app" onchange="toggleParcelas(this)">
                    <option value="Avista">À Vista</option>
                    <option value="Parcelado">Parcelado</option>
                </select>
            </div>
        </div>

        <!-- ÁREA DE PARCELAMENTO (Layout corrigido) -->
        <div id="areaParcelamento" class="mb-3 bg-light p-3 rounded-4 border" style="display:none;">
            <div class="row g-3">
                <div class="col-6">
                    <label class="form-label-app small">Parcelas</label>
                    <input type="number" name="QtdParcelas" class="form-control-app" placeholder="Ex: 12" min="2">
                </div>
                <div class="col-6">
                    <label class="form-label-app small">Intervalo (Dias)</label>
                    <input type="number" name="FrequenciaDias" class="form-control-app" placeholder="30" value="30">
                </div>
            </div>
        </div>

        <!-- SEÇÃO 3: CONFIGURAÇÕES -->
        <div class="section-label"><span class="section-dot dot-purple"></span> Configurações</div>

        <!-- SWITCH DE STATUS (Lógica invertida: Check=Pago, Uncheck=Pendente) -->
        <div class="status-card" onclick="if(!event.target.closest('.switch-app')) document.getElementById('chkStatus').click()">
            <div>
                <div class="fw-bold text-success" id="statusLabel">@(isReceita ? "Recebida (Efetivada)" : "Paga (Efetivada)")</div>
                <div class="small text-muted">A transação já foi efetivada?</div>
            </div>
            <label class="switch-app">
                <input type="checkbox" id="chkStatus" checked onchange="toggleStatus(this)">
                <span class="slider"></span>
            </label>
            <input type="hidden" asp-for="Status" id="inputStatus" value="2" />
        </div>

        <div class="mb-3">
            <label asp-for="DataFluxo" class="form-label-app">Vencimento</label>
            <input type="date" asp-for="DataFluxo" class="form-control-app" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>

        <div class="mb-3">
            <label asp-for="IdConta" class="form-label-app">Conta</label>
            <select asp-for="IdConta" class="form-select-app" asp-items="ViewBag.Contas">
                <option value="">Não informado</option>
            </select>
        </div>

        <div class="mb-3">
            <label asp-for="IdPessoa" class="form-label-app">Pessoa / Fornecedor</label>
            <select asp-for="IdPessoa" class="form-select-app" asp-items="ViewBag.Pessoas">
                <option value="">Selecione...</option>
            </select>
        </div>

        <!-- Botões de Ação -->
        <div class="px-2">
            <button type="button" class="btn-save-app btn-save-big" onclick="submitLancamento()">
                <i class="bi @(isReceita ? "bi-arrow-up" : "bi-arrow-down") me-2"></i> Salvar @tipoTexto
            </button>
            <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        </div>

        <div style="height: 20px;"></div>
    </div>
</form>

<!-- MODAIS DE CADASTRO RÁPIDO -->
<div id="modalNovaCategoria" class="position-absolute top-0 start-0 w-100 h-100 bg-white rounded-4 p-4 overlay-center" style="display:none; z-index: 1055;">
    <h5 class="modal-title-app mb-4"><i class="bi bi-tag"></i> Nova Categoria</h5>
    <div class="mb-3">
        <label class="form-label-app">Nome da Categoria</label>
        <input type="text" id="newCatName" class="form-control-app" placeholder="Ex: Transporte" />
    </div>
    <button type="button" class="btn-save-app btn-save-big mt-2" onclick="salvarNovaCategoria()">Salvar</button>
    <button type="button" class="btn-cancel" onclick="$('#modalNovaCategoria').fadeOut()">Voltar</button>
</div>

<div id="modalNovaSubcategoria" class="position-absolute top-0 start-0 w-100 h-100 bg-white rounded-4 p-4 overlay-center" style="display:none; z-index: 1055;">
    <h5 class="modal-title-app mb-4"><i class="bi bi-tags"></i> Nova Subcategoria</h5>
    <div class="alert alert-light border small text-muted mb-3">
        Vinculada à categoria: <strong id="lblCatVinculada">-</strong>
    </div>
    <input type="hidden" id="newSubCatPaiId" />
    <div class="mb-3">
        <label class="form-label-app">Nome da Subcategoria</label>
        <input type="text" id="newSubCatName" class="form-control-app" placeholder="Ex: Uber / Táxi" />
    </div>
    <button type="button" class="btn-save-app btn-save-big mt-2" onclick="salvarNovaSubcategoria()">Salvar</button>
    <button type="button" class="btn-cancel" onclick="$('#modalNovaSubcategoria').fadeOut()">Voltar</button>
</div>

<script>
    // --- CARREGAMENTO DE SUBCATEGORIAS ---
    function carregarSubcategorias(idCategoria) {
        var subSelect = $('#IdSubcategoria');

        if (!idCategoria) {
            subSelect.empty().append('<option value="">Selecione a categoria...</option>').prop('disabled', true);
            return;
        }

        subSelect.empty().append('<option value="">Carregando...</option>').prop('disabled', true);

        $.ajax({
            url: '/Lancamentos/GetSubcategorias',
            type: 'GET',
            data: { categoriaId: idCategoria },
            success: function (data) {
                subSelect.empty().append('<option value="">Selecione...</option>');

                if (data && data.length > 0) {
                    $.each(data, function (index, item) {
                        subSelect.append($('<option>', { value: item.id, text: item.nome }));
                    });
                    subSelect.prop('disabled', false);
                } else {
                    subSelect.append('<option value="">Nenhuma subcategoria</option>');
                    subSelect.prop('disabled', false);
                }
            },
            error: function () {
                subSelect.empty().append('<option value="">Erro ao carregar</option>');
            }
        });
    }

    // --- MODAIS DE CADASTRO RÁPIDO ---
    function abrirModalCategoria() {
        $('#newCatName').val('');
        $('#modalNovaCategoria').fadeIn();
    }

    function salvarNovaCategoria() {
        var nome = $('#newCatName').val();
        var tipo = $('input[name="TipoLancamento"]').val();

        if(!nome) return alert("Digite o nome da categoria!");

        var btn = $('#modalNovaCategoria .btn-save-big');
        var originalText = btn.html();
        btn.prop('disabled', true).html('Salvando...');

        $.post('/Lancamentos/SalvarCategoriaRapida', { nome: nome, tipo: tipo }, function(res){
             if(res.success) {
                 var newOption = new Option(res.nome, res.id, true, true);
                 $('#IdTipo').append(newOption).trigger('change');
                 $('#modalNovaCategoria').fadeOut();
             } else {
                 alert(res.message);
             }
             btn.prop('disabled', false).html(originalText);
        }).fail(function() {
             alert('Erro ao salvar categoria.');
             btn.prop('disabled', false).html(originalText);
        });
    }

    function abrirModalSubcategoria() {
        var catId = $('#IdTipo').val();
        var catNome = $('#IdTipo option:selected').text();

        if(!catId) {
            alert("Selecione uma Categoria Pai primeiro!");
            return;
        }

        $('#newSubCatPaiId').val(catId);
        $('#lblCatVinculada').text(catNome);
        $('#newSubCatName').val('');
        $('#modalNovaSubcategoria').fadeIn();
    }

    function salvarNovaSubcategoria() {
        var nome = $('#newSubCatName').val();
        var paiId = $('#newSubCatPaiId').val();

        if(!nome) return alert("Digite o nome da subcategoria!");

        var btn = $('#modalNovaSubcategoria .btn-save-big');
        var originalText = btn.html();
        btn.prop('disabled', true).html('Salvando...');

        $.post('/Lancamentos/SalvarSubcategoriaRapida', { nome: nome, idTipo: paiId }, function(res){
             if(res.success) {
                 var newOption = new Option(res.nome, res.id, true, true);
                 $('#IdSubcategoria').append(newOption);
                 $('#IdSubcategoria option:contains("Nenhuma subcategoria")').remove();
                 $('#modalNovaSubcategoria').fadeOut();
             } else {
                 alert(res.message);
             }
             btn.prop('disabled', false).html(originalText);
        }).fail(function() {
             alert('Erro ao salvar subcategoria.');
             btn.prop('disabled', false).html(originalText);
        });
    }

    // --- INTERFACE (Parcelas, Status) ---
    function toggleParcelas(select) {
        const area = document.getElementById('areaParcelamento');
        if (select.value === 'Parcelado') {
            area.style.display = 'block';
            setTimeout(() => area.querySelector('input').focus(), 100);
            document.querySelector('.scroll-container').scrollTop += 100;
        } else {
            area.style.display = 'none';
        }
    }

    function toggleStatus(checkbox) {
        const label = document.getElementById('statusLabel');
        const input = document.getElementById('inputStatus');
        const isReceita = '@isReceita' === 'True';

        if (checkbox.checked) {
            label.innerText = isReceita ? "Recebida (Efetivada)" : "Paga (Efetivada)";
            label.className = "fw-bold text-success";
            input.value = "2";
        } else {
            label.innerText = isReceita ? "Não Recebida (Pendente)" : "Não Paga (Pendente)";
            label.className = "fw-bold text-danger";
            input.value = "1";
        }
    }

    function submitLancamento() {
        var form = $('#formLancamento')[0];
        var formData = new FormData(form);

        var object = {};
        formData.forEach(function(value, key){
            object[key] = value;
        });

        // === CORREÇÃO DO VALOR ===
        if (object.Valor) {
            object.ValorOriginal = object.Valor;
        }

        var btn = $('.px-2 .btn-save-big');
        var originalText = btn.html();
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span> Salvando...');

        $.ajax({
            url: '/api/financeiro/lancamentos',
            type: 'POST',
            data: JSON.stringify(object),
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                if (response.success) {
                    $('#LancamentoModal').modal('hide');
                    if(typeof carregarLancamentos === 'function') { carregarLancamentos(); } else { location.reload(); }
                } else {
                    alert('Erro: ' + response.message);
                    btn.prop('disabled', false).html(originalText);
                }
            },
            error: function (xhr) {
                var msg = 'Erro ao salvar.';
                if(xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                alert(msg);
                btn.prop('disabled', false).html(originalText);
            }
        });
    }
</script>